<docbook><section><title>VirtDeployingLinkedDataGuide_UsingVirtuoso</title><para> </para>
<title> Deploying Linked Data Guide - Part 2: Deploying Linked Data Using Virtuoso</title> Deploying Linked Data Guide - Part 2: Deploying Linked Data Using Virtuoso
 <ulink url="">
  <ulink url="VirtDeployingLinkedDataGuide">Deploying Linked Data - Overall TOC</ulink><bridgehead class="http://www.w3.org/1999/xhtml:h2">Section Contents</bridgehead>
<itemizedlist mark="bullet" spacing="compact"><listitem><ulink url="#AncmozTocId923721">Deploying Linked Data using Virtuoso</ulink> <itemizedlist mark="bullet" spacing="compact"><listitem><ulink url="#AncmozTocId644758">The Virtuoso Rule-Based URL Rewriter</ulink> </listitem>
<listitem><ulink url="#AncmozTocId254803">Conductor UI for the URL Rewriter</ulink> </listitem>
<listitem><ulink url="#AncmozTocId369762">Virtual Domains (Hosts) &amp; Directories</ulink> </listitem>
<listitem><ulink url="#AncmozTocId904741">&quot;Nice&quot; URLs vs. &quot;Long&quot; URLs</ulink> </listitem>
<listitem><ulink url="#AncmozTocId768867">Rule Processing Mechanics</ulink> </listitem>
<listitem><ulink url="#AncmozTocId313638">Enabling URL Rewriting via the Virtuoso Conductor UI</ulink> <itemizedlist mark="bullet" spacing="compact"><listitem><ulink url="#AncmozTocId185357">Northwind Demonstration Database</ulink> </listitem>
<listitem><ulink url="#AncmozTocId132652">Configuring Rewrite Rules using Conductor</ulink> </listitem>
<listitem><ulink url="#AncmozTocId76317">Dissection of Northwind Rewrite Rules Configured using Conductor</ulink> <itemizedlist mark="bullet" spacing="compact"><listitem><ulink url="#AncmozTocId475034">Regex Rule for RDF Requests</ulink> </listitem>
<listitem><ulink url="#AncmozTocId409168">Constructing the Destination Path Format</ulink> </listitem>
<listitem><ulink url="#AncmozTocId376477">Data Flow in Conductor-Defined Northwind RDF Regex Rule</ulink> </listitem>
<listitem><ulink url="#AncmozTocId146750">Regex Rule for HTML Requests</ulink> </listitem>
</itemizedlist></listitem>
</itemizedlist></listitem>
<listitem><ulink url="#AncmozTocId83837">Enabling URL Rewriting via Virtuoso PL</ulink> <itemizedlist mark="bullet" spacing="compact"><listitem><ulink url="#AncmozTocId618240">Exporting Rewrite Rules from Conductor</ulink> </listitem>
<listitem><ulink url="#AncmozTocId374304">Defining Virtual Hosts in Virtuoso PL</ulink> </listitem>
<listitem><ulink url="#AncmozTocId234279">URL Rewriting Configuration API</ulink> </listitem>
<listitem><ulink url="#AncmozTocId96294">Creating Rewrite Rules</ulink> <itemizedlist mark="bullet" spacing="compact"><listitem><ulink url="#AncmozTocId572134"><span style="color: red">
      UNKNOWN tag:
      http://www.w3.org/1999/xhtml:nowikiURLREWRITE_CREATE_REGEX_RULE</span></ulink> </listitem>
</itemizedlist></listitem>
<listitem><ulink url="#AncmozTocId878640">Dissection of Northwind Rewrite Rules Configured using Virtuoso PL</ulink> <itemizedlist mark="bullet" spacing="compact"><listitem><ulink url="#AncmozTocId31722">Data Flow in Virtuoso/PL-Defined Northwind RDF Regex Rule</ulink> </listitem>
</itemizedlist></listitem>
</itemizedlist></listitem>
<listitem><ulink url="#AncmozTocId719555">Northwind URL Rewriting Verification Using cURL</ulink></listitem>
</itemizedlist></listitem>
</itemizedlist><ulink url="">
<para> </para>
<bridgehead class="http://www.w3.org/1999/xhtml:h2"> Deploying Linked Data using Virtuoso</bridgehead>
<para>The preceding sections described a generic approach to deploying Linked Data into the existing Web.
 We now turn our attention to Virtuoso, to describe its solution for Linked Data deployment.
 In fact, Virtuoso&#39;s solution is to implement the generic approach outlined in the prior sections, using the twin pillars of content negotiation and URL rewriting.</para>
<para> <ulink url="">
 </ulink></para>
<bridgehead class="http://www.w3.org/1999/xhtml:h3"> The Virtuoso Rule-Based URL Rewriter</bridgehead>
<para> Virtuoso provides a URL rewriter that can be enabled for URLs matching specified patterns.
 Coupled with customizable HTTP response headers and response codes, Linked Data Web server administrators can configure highly flexible rules for driving content negotiation and URL rewriting.
 The key elements of the URL rewriter are:</para>
<itemizedlist mark="bullet" spacing="compact"><listitem>Rewrite rule <itemizedlist mark="bullet" spacing="compact"><listitem>Each rule describes how to parse a single source URL, and how to compose the URL of the page ultimately returned in the &quot; Location: &quot; response headers </listitem>
<listitem>Every rewrite rule is uniquely identified internally (using IRIs).
</listitem>
<listitem>Two types of rule are supported, based on the syntax used to describe the source URL pattern matching - sprintf-based and regex-based.
</listitem>
</itemizedlist></listitem>
<listitem>Rewrite rule list <itemizedlist mark="bullet" spacing="compact"><listitem>A named ordered-list of rewrite rules or rule lists where rules of the list are processed from top to bottom or in line with processing pipeline precedence instructions </listitem>
</itemizedlist></listitem>
<listitem>Configuration API <itemizedlist mark="bullet" spacing="compact"><listitem>Defines functions for creating, dropping, and enumerating rules and rule lists.
</listitem>
</itemizedlist></listitem>
<listitem>Virtual hosts and virtual paths <itemizedlist mark="bullet" spacing="compact"><listitem>URL rewriting is enabled by associating a rewrite rules list with a virtual directory</listitem>
</itemizedlist></listitem>
</itemizedlist><para>Each of these elements is described in more detail below, although complete descriptions of the features or functions in question are not given.
 The intention here is to provide an overview of Virtuoso&#39;s URL rewriting capabilities and their application to deploying Linked Data.
 Please refer to the <ulink url="http://docs.openlinksw.com/virtuoso/">Virtuoso Reference Documentation</ulink> for full details.</para>
<para> <ulink url="">
 </ulink></para>
<bridgehead class="http://www.w3.org/1999/xhtml:h3"> Conductor UI for the URL Rewriter</bridgehead>
<para> Virtuoso is a full-blown HTTP server in its own right.
 The HTTP server functionality co-exists with the product core (i.e.
 DBMS Engine, Web Services Platform, WebDAV filesystem, and other components of the Universal Server).
 As a result, it has the ability to multi-home Web domains within a single instance across a variety of domain name and port combinations.
 In addition, it also enables the creation of multiple virtual directories per domain.</para>
<para> In addition to the basic functionality describe above, Virtuoso lets you associate URL rewrite rules with the virtual directories associated with a particular hosted Web domain.</para>
<para> In all cases, Virtuoso enables you to configure virtual domains, virtual directories and URL rewrite rules for one or more virtual directories, via the (X)HTML-based Conductor Admin User Interface or a collection of Virtuoso Stored Procedure Language (PL)-based APIs.</para>
<para> <ulink url="">
 </ulink></para>
<bridgehead class="http://www.w3.org/1999/xhtml:h3"> Virtual Domains (Hosts) &amp; Directories</bridgehead>
 A Virtuoso virtual directory maps a logical path to a physical directory in your file system or WebDAV repository.
 This mechanism allows physical locations to be hidden or simply reorganised.
 Virtual directory definitions are held in the system table DB.DBA.HTTP_PATH.
 Virtual directories can be administered in three basic ways: <itemizedlist mark="bullet" spacing="compact"><listitem>Using the Visual Administration Interface via a Web browser; </listitem>
<listitem>Using the functions vhost_define() and vhost_remove(); and </listitem>
<listitem>Using SQL statements to directly update the HTTP_PATH system table.</listitem>
</itemizedlist><ulink url="">
<para> </para>
<bridgehead class="http://www.w3.org/1999/xhtml:h3"> &quot;Nice&quot; URLs vs.
 &quot;Long&quot; URLs</bridgehead>
<para> Although we are approaching the URL Rewriter from the perspective of deploying Linked Data, the rewriter was developed with additional objectives in mind.
 These in turn have influenced the naming of some of the formal argument names in the Configuration API function prototypes.
 In the following sections, &quot;long&quot; URLs are those containing a query string with named parameters; &quot;nice&quot; (also known as &quot;source&quot;) URLs have data encoded in some other format.
 The primary goal of the Rewriter was to accept a nice URL from an application and convert this into a long URL, which then identifies the page that should actually be retrieved.</para>
<para> <ulink url="">
 </ulink></para>
<bridgehead class="http://www.w3.org/1999/xhtml:h3"> Rule Processing Mechanics</bridgehead>
<para> When an HTTP request is accepted by the Virtuoso HTTP server, the received nice URL is passed to an internal path translation function.
 This function takes the nice URL and, if the current virtual directory has a url_rewrite option set to an existing rule list name, tries to match the corresponding rule lists and rules; that is, the function performs a recursive traversal of any rule list associated with the virtual directory.
 For every rule in the rule list, the same logic is applied (only the logic for regex-based rules is described; that for sprintf-based rules is very similar):</para>
<itemizedlist mark="bullet" spacing="compact"><listitem>The input for the rule is the resource URL as received from the HTTP header, i.e., the portion of the URL from the first &#39;/&#39; after the host:port fields to the end of the URL.
</listitem>
<listitem>The input is <ulink url="http://en.wikipedia.org/wiki/Url_normalization">normalized</ulink> . </listitem>
<listitem>The input is matched against the rule&#39;s regex.
 If the match fails, the rule is not applied and the next rule is tried.
 If the match succeeds, the result is a vector of values.
</listitem>
<listitem>If the URL contains a query string, the names and values of the parameters are decoded by split_and_decode().
</listitem>
<listitem>The names and values of any parameters in the request body are also decoded.
</listitem>
<listitem>The destination URL is composed.
<itemizedlist mark="bullet" spacing="compact"><listitem>The value of each parameter in the destination URL is taken from (in order of priority): </listitem>
<listitem>the value of a parameter in the match result; </listitem>
<listitem>the value of a named parameter in the query string of the input nice URL; </listitem>
<listitem>if the original request was submitted by the POST method, the value of a named parameter in the body of the POST request; or </listitem>
</itemizedlist></listitem>
<listitem>if a parameter value cannot be derived from one of these sources, the rule is not applied and the next rule is tried.<emphasis /></listitem>
</itemizedlist><emphasis>Note:</emphasis> The path translation function described above is internal to the Web server, so its signature is not appropriate for Virtuoso/PL calls and thus is not published.
 Virtuoso/PL developers can harness the same functionality using the DB.DBA.URLREWRITE_APPLY API call.<ulink url="">
<para> </para>
<bridgehead class="http://www.w3.org/1999/xhtml:h3"> Enabling URL Rewriting via the Virtuoso Conductor UI</bridgehead>
<para> The URL rewriting examples which follow are taken from the Virtuoso Northwind demonstration database, which is included in the Demo VAD (Virtuoso Application Distribution) archive.
</para><table><title /><tgroup><thead /><tbody><row><entry>
<para>To check which version of the Demo VAD is installed, or to upgrade it, refer to the Conductor&#39;s &#39;<emphasis>VAD Packages</emphasis>&#39; screen, reachable through the &#39;<emphasis>System Admin</emphasis>&#39; &gt; &#39;<emphasis>Packages</emphasis>&#39; menu items.</para>
<para> The latest VADs for the closed source releases of Virtuoso can be downloaded from the <ulink url="https://virtuoso.openlinksw.com/download/">downloads area</ulink> of the OpenLink website.
 Select either the &#39;DBMS (WebDAV) Hosted&#39; or &#39;File System Hosted&#39; product format from the &#39;Distributed Collaborative Applications&#39; section, depending on whether you want the Virtuoso application to be run from WebDAV or native filesystem storage.
 VADs for Virtuoso Open Source edition (VOS) are available for <ulink url="http://virtuoso.openlinksw.com/dataspace/dav/wiki/Main/VOSDownload">download</ulink> from the VOS Wiki.
</para></entry></row></tbody></tgroup></table>
<ulink url="">
<para> </para>
<bridgehead class="http://www.w3.org/1999/xhtml:h4"> Northwind Demonstration Database</bridgehead>
<para> The Virtuoso Northwind database (contained in the &quot;Demo&quot; catalog) is very similar to the Northwind example database available for SQL Server.
 Its schema comprises commonly understood SQL tables that include: Customers, Orders, Employees, Products, Product Categories, Shippers, Countries, Provinces etc.</para>
<para> Northwind is installed with a preconfigured Linked Data View and a set of preconfigured URL rewrite rules that collectively expose RDF based entity graphs and URLs of (X)HTML web pages that describe the back-end relational data.</para>
<para> An Linked Data View over relational data is a named collection (graph) of RDF records (triples) derived from an RDBMS-to-RDF source data map exposed via a Virtuoso Quad Store.
 The process of declaring Linked Data Views over RDBMS data using the Virtuoso Meta-schema Language is described in detail in our <ulink url="http://virtuoso.openlinksw.com/Whitepapers/pdf/Virtuoso_SQL_to_RDF_Mapping.pdf">Linked Data Views of SQL</ulink> white paper.</para>
<para> To view the Northwind entity graph in RDF format, starting with the entity &quot;ALFKI&quot;, simply place the following document URL into the <ulink url="http://demo.openlinksw.com/ode">OpenLink Data Explorer</ulink> : http://demo.openlinksw.com/Northwind/Customer/ALFKI</para>
<para>Alternatively, you can view an (X)HTML based description of the entity &quot;ALFKI&quot; by pointing your Web browser to the same URL.
 (The details of these URLs will be explained shortly; for now they are presented purely as pointers to illustrate example data available from Northwind.)</para>
<para> <ulink url="">
 </ulink></para>
<bridgehead class="http://www.w3.org/1999/xhtml:h4"> Configuring Rewrite Rules using Conductor</bridgehead>
<para> The steps for configuring URL Rewrite rules via the Virtuoso Conductor are as follows:</para>
<orderedlist spacing="compact"><listitem>Click to the &quot;<emphasis>Web Application Server</emphasis>&quot; &gt; &quot;<emphasis>Virtual Domains &amp; Directories</emphasis>&quot; tabs.
<para><figure><graphic fileref="VirtDeployingLinkedDataGuide_UsingVirtuoso/fig2.png" /></figure> <emphasis>Conductor&#39;s Hosted Domains and Virtual Directories screen</emphasis> </para> </listitem>
<listitem>Pick the domain that contains the virtual directories to which the rules are to be applied (in this case the default was taken).
<para><figure><graphic fileref="VirtDeployingLinkedDataGuide_UsingVirtuoso/fig3.jpg" /></figure> <emphasis>Accessing the URL rewrite rules for the Northwind demo database</emphasis> </para> </listitem>
<listitem>Click on the &quot;<emphasis>URL-rewrite</emphasis>&quot; link to create, delete, or edit a rule as shown below.
</listitem>
<listitem>Create a rule for HTML based representations of resource description requests.
<para><figure><graphic fileref="VirtDeployingLinkedDataGuide_UsingVirtuoso/fig4.jpg" /></figure> <emphasis>Northwind URL rewrite rule for HTML requests</emphasis> </para> </listitem>
<listitem>Create a rule for N3 or RDF/XML based representations or resource descriptions.
<para><figure><graphic fileref="VirtDeployingLinkedDataGuide_UsingVirtuoso/fig5.jpg" /></figure> <emphasis>Northwind URL rewrite rule for RDF requests</emphasis> </para> </listitem>
<listitem>Save your rules, exit the Conductor, and test your rules with &quot; cURL &quot; or any other HTTP-based user agent.</listitem>
</orderedlist><ulink url="">
<para> </para>
<bridgehead class="http://www.w3.org/1999/xhtml:h4"> Dissection of Northwind Rewrite Rules Configured using Conductor</bridgehead>
<para> The screenshots above show the default Northwind rewrite rules.
 Let&#39;s analyze what they are doing.</para>
<para> <ulink url="">
 </ulink></para>
<bridgehead class="http://www.w3.org/1999/xhtml:h5"> Regex Rule for RDF Requests</bridgehead>
<para>The regex rule for handling RDF/XML or N3 representation requests specifies a &#39;<emphasis>Request Path Pattern</emphasis>&#39; of <emphasis>(/[^#]*)</emphasis>.
 Recall that the input path is the portion of the input URL from the first &#39;/&#39; after the host:port fields to the end of the normalized URL.
 So, given a request for http://demo.openlinksw.com/Northwind/Customer/ALFKI, the request path pattern would match /Northwind/Customer/ALFKI.
 Parentheses in the pattern collect the results of the pattern matching into parameters.
 Each successive pair of parentheses denotes a parameter, referred to elsewhere in the rewrite rule as $U1, $U2, $U3, ...
 , or $s1, $s2, $s3, ...
 , etc.
 These parameters can then be used to substitute a part of the input path that was matched into the new URL being composed.
 The parameter markers $U1 and $s1 (likewise $U2 and $s2 etc.) identify the same pattern segment in the request path pattern.
 The only difference between them is how the matched text is encoded when it is inserted into the new URL.
 The &#39;s&#39; format specifier inserts the matched text as is, whereas the &#39;U&#39; format specifier causes the inserted text to be URL encoded.</para>
<para>Content types specified in the request&#39;s Accept header and matched by the &#39;Accept Header Request Pattern&#39; are available for substitution into the rewritten URL through the $accept variable.</para>
<para> Rather than hardcoding host names and ports, the rules are made more generic by using the convenience macro URIQADefaultHost.
 Every occurrence of ^{URIQADefaultHost}^ will be substituted with the value of the DefaultHost parameter defined in the URIQA section of the Virtuoso configuration file, virtuoso.ini.
 &quot;DefaultHost&quot; is the &quot;canonical&quot; server name that is used to identify the service.
 It should be either a server host name including domain (i.e.
 an FQDN), or an IP address in standard notation.
 If Virtuoso&#39;s default HTTP port is not equal to 80 then the port should also be included, e.g.
 &quot;www.example.com:8890&quot;.</para>
<para> <ulink url="">
 </ulink></para>
<bridgehead class="http://www.w3.org/1999/xhtml:h5"> Constructing the Destination Path Format</bridgehead>
<para> The parameter markers, variables and macros just described provide the building blocks for constructing the &#39;<emphasis>Destination Path Format</emphasis>&#39; which serves as a template for the rewritten URL.
 It must be stressed that <emphasis>it is not necessary to URL-encode the Destination Path Format by hand</emphasis>.
 You need only write the underlying CONSTRUCT or DESCRIBE SPARQL query.
 When defining a new Destination Path Format, click on the SPARQL button to enable a text box (shown below) into which you can enter the base SPARQL query which will describe the entity being dereferenced.
 On clicking the &#39;<emphasis>Format</emphasis>&#39; button to return, the SPARQL query will be expanded into a full query string, including a result-set format-specifier, and URL-encoded automatically.
 For example, the base query: </para>
<programlisting>DESCRIBE &lt;http://^{URIQADefaultHost}^$U1#this&gt; &lt;http://^{URIQADefaultHost}^$U1&gt; FROM &lt;http://^{URIQADefaultHost}^/Northwind&gt;
</programlisting><para>becomes: </para>
<programlisting>/sparql?query=DESCRIBE+%3Chttp%3A//^{URIQADefaultHost}^$U1%23this%3E+%3Chttp%3A//^{URIQADefaultHost}^$U1%3E
    +FROM+%3Chttp%3A//^{URIQADefaultHost}^/Northwind%3E&amp;format=$accept
</programlisting><table><title /><tgroup><thead /><tbody><row><entry><para>The pre-configured DESCRIBE query for Northwind describes two entities:  http://^{URIQADefaultHost}^/Northwind/Customer/ALFKI#thisand http://^{URIQADefaultHost}^/Northwind/Customer/ALFKI<emphasis> http://^{URIQADefaultHost}^/Northwind/Customer/ALFKI</emphasis> identifies a document (an entity of type foaf:Document) that has the entity <emphasis>http://^{URIQADefaultHost}^/Northwind/Customer/ALFKI#this</emphasis> as its foaf:PrimaryTopic property value.
 This relationship is the key to using the description of the document (a report) about &quot;ALFKI&quot; to expose the deeper entity graph that describes the entity &quot;ALFKI#this&quot;.</para></entry></row></tbody></tgroup></table> <para><figure><graphic fileref="VirtDeployingLinkedDataGuide_UsingVirtuoso/fig6.jpg" /></figure> <emphasis>Defining the SPARQL query for the Northwind RDF requests</emphasis> </para>
<ulink url="">
<para> </para>
<bridgehead class="http://www.w3.org/1999/xhtml:h5"> Data Flow in Conductor-Defined Northwind RDF Regex Rule</bridgehead>
<para> The process of rewriting a request for an RDF representation of Northwind customer ALFKI, through the corresponding regex rule, is depicted below as a data flow diagram.
 The arcs connecting similarly-colored items attempt to illustrate how portions of the input request are matched and substituted into the rewritten request.</para>
<para><figure><graphic fileref="VirtDeployingLinkedDataGuide_UsingVirtuoso/fig7.png" /></figure> <emphasis>Breakdown of the URL rewriting process for Northwind RDF requests</emphasis> </para><ulink url="">
<para> </para>
<bridgehead class="http://www.w3.org/1999/xhtml:h5"> Regex Rule for HTML Requests</bridgehead>
<para> The Northwind regex rule for HTML requests functions in a similar way to the regex rule for RDF requests.
 That is, the mechanisms for pattern matching and parameter substitution are the same.
 The only differences are the content types matched and the target URL.</para>
<para>In this case, the destination path format is: /about/html/http://^{URIQADefaultHost}^$s1</para>
<para>Here, the path /about/html/ redirects the client to the <ulink url="http://virtuoso.openlinksw.com/Whitepapers/pdf/sponger_whitepaper_10102007.pdf">Virtuoso Sponger</ulink> proxy interface.
 The Sponger itself is a highly customizable RDFizer.
 Virtuoso reserves two paths for the proxy service, &#39;/about/rdf/&#39; and &#39;/about/html/&#39;.
 (<emphasis>Note:</emphasis> These proxy paths have since been augmented to support a richer slash URI scheme for identifying format variants.
 Please refer to <ulink url="VirtDeployingLinkedDataGuide_AppendixB">Appendix B</ulink> for more details.) The web service takes the target URL following the proxy path and either returns the content &quot;as is&quot; or tries to transform it to RDF.
 The RDF graph derived from the sponging process is then rendered in one of the RDF serialization formats (RDF/XML or N3) or HTML depending on whether the request specified /about/rdf/ or /about/html/.
 Thus, the proxy service can be used as middleware for enabling RDF based exploration of non-RDF sources using dedicated RDF browsers or standard (X)HTML browsers.</para>
<para> The mechanism through which Virtuoso composes an HTML rendering of RDF data (whether this be a native RDF description, or one extracted by the Sponger) is via the &quot;description.vsp&quot; rendering template, a specialized <ulink url="http://docs.openlinksw.com/virtuoso/vsp1.html">Virtuoso Server Page</ulink> specifically aimed at RDF-model-based resource description.
 The &quot;description.vsp&quot; template is described in more detail in Appendix A.
 A usage example covering the description of the entity &lt;http://demo.openlinksw.com/Northwind/Customer/ALFKI#this&gt; is shown below.</para>
<para><figure><graphic fileref="VirtDeployingLinkedDataGuide_UsingVirtuoso/fig8.jpg" /></figure> <emphasis>description.vsp HTML rendering of Customer entity ALFKI</emphasis> </para><ulink url="">
<para> </para>
<bridgehead class="http://www.w3.org/1999/xhtml:h3"> Enabling URL Rewriting via Virtuoso PL</bridgehead>
<para> While the Conductor UI provides the easiest way to set up URL rewriting, on occasion it may be preferable to configure URL rewriting programmatically using Virtuoso PL.</para>
<para> <ulink url="">
 </ulink></para>
<bridgehead class="http://www.w3.org/1999/xhtml:h4"> Exporting Rewrite Rules from Conductor</bridgehead>
<para>The Conductor lets you export configured rules as Virtuoso PL, making it easier to use them on another system, for instance.
 The exported script recreates the rewrite rules using Virtuoso&#39;s URL Rewriting Configuration API.</para>
<para><figure><graphic fileref="VirtDeployingLinkedDataGuide_UsingVirtuoso/fig9.jpg" /></figure> <emphasis>Conductor&#39;s &#39;Export&#39; button for exporting URL rewrite rules</emphasis> </para><para>The code listing below shows the exported Northwind rules.
 Describing the Configuration API and this exported rules file forms the focus of this section.
<span style="color: red">
      UNKNOWN tag:
      http://www.w3.org/1999/xhtml:verbatimDB.DBA.VHOST_REMOVE ( lhost=&gt;&#39;*ini*&#39;, vhost=&gt;&#39;*ini*&#39;, lpath=&gt;&#39;/Northwind&#39;);DB.DBA.VHOST_DEFINE ( lhost=&gt;&#39;*ini*&#39;, vhost=&gt;&#39;*ini*&#39;, lpath=&gt;&#39;/Northwind&#39;, ppath=&gt;&#39;/DAV/home/demo/&#39;, is_dav=&gt;1, vsp_user=&gt;&#39;dba&#39;, ses_vars=&gt;0, opts=&gt;vector (&#39;url_rewrite&#39;, &#39;demo_nw_rule_list1&#39;), is_default_host=&gt;0);DB.DBA.URLREWRITE_CREATE_RULELIST (&#39;demo_nw_rule_list1&#39;, 1, vector (&#39;demo_nw_rule1&#39;, &#39;demo_nw_rule2&#39;));DB.DBA.URLREWRITE_CREATE_REGEX_RULE (&#39;demo_nw_rule1&#39;, 1, &#39;(/[^#]*)&#39;,vector (&#39;path&#39;),1,&#39;/about/html/http://^{URIQADefaultHost}^%s&#39;,vector (&#39;path&#39;),NULL,&#39;(text/html)|(\\*/\\*)&#39;,0, 303, NULL );DB.DBA.URLREWRITE_CREATE_REGEX_RULE (&#39;demo_nw_rule2&#39;, 1, &#39;(/[^#]*)&#39;,vector (&#39;path&#39;),1,&#39;/sparql?query=DESCRIBE+%%3Chttp%%3A//^{URIQADefaultHost}^%U%%23this%%3E+%%3Chttp%%3A//^{URIQADefaultHost}^%U%%3E    +FROM+%%3Chttp%%3A//^{URIQADefaultHost}^/Northwind%%3E&amp;format=%U&#39;,vector (&#39;path&#39;, &#39;path&#39;, &#39;*accept*&#39;),NULL,&#39;(text/rdf.n3)|(application/rdf.xml)&#39;,0, NULL, NULL );</span></para>
<table><title /><tgroup><thead /><tbody><row><entry><emphasis>Exporting Rewrite Rules from a Script</emphasis><para>Use the function DB.DBA.URLREWRITE_DUMP_RULELIST_SQL to export rule lists programmatically.
 e.g.
 From isql, you can generate the listing shown above by executing:  SELECT DB.DBA.URLREWRITE_DUMP_RULELIST_SQL(&#39;demo_nw_rule_list1&#39;) </para></entry></row></tbody></tgroup></table>
<ulink url="">
<para> </para>
<bridgehead class="http://www.w3.org/1999/xhtml:h4"> Defining Virtual Hosts in Virtuoso PL</bridgehead>
<para> As can be seen above, the vhost_define() API call is used to define virtual hosts and virtual paths hosted by the Virtuoso HTTP server.
 URL rewriting is enabled through this function&#39;s opts parameter.
 opts is of type ANY, e.g.
 a vector of field-value pairs.
 Numerous fields are recognized for controlling different options.
 The field value url_rewrite controls URL rewriting.
 The corresponding field value is the IRI of a rule list to apply.</para>
<para> <ulink url="">
 </ulink></para>
<bridgehead class="http://www.w3.org/1999/xhtml:h4"> URL Rewriting Configuration API</bridgehead>
<para> Virtuoso includes the following functions for managing URL rewrite rules and rule lists.
 The names are self-explanatory.</para>
<itemizedlist mark="bullet" spacing="compact"><listitem><emphasis>DB.DBA.URLREWRITE_DROP_RULE</emphasis> - Deletes a rewrite rule.
</listitem>
<listitem><emphasis>DB.DBA.URLREWRITE_CREATE_SPRINTF_RULE</emphasis> - Creates a rewrite rule which uses sprintf-based pattern matching.
</listitem>
<listitem><emphasis>DB.DBA.URLREWRITE_CREATE_REGEX_RULE</emphasis> - Creates a rewrite rule which uses regular expression (regex)-based pattern matching.
</listitem>
<listitem><emphasis>DB.DBA.URLREWRITE_DROP_RULELIST</emphasis> - Deletes a rewrite rule list.
</listitem>
<listitem><emphasis>DB.DBA.URLREWRITE_CREATE_RULELIST</emphasis> - Creates a rewrite rule list.
</listitem>
<listitem><emphasis>DB.DBA.URLREWRITE_ENUMERATE_RULES</emphasis> - Lists all the rules whose IRIs match the specified &#39;SQL like&#39; pattern.
</listitem>
<listitem><emphasis>DB.DBA.URLREWRITE_ENUMERATE_RULELISTS</emphasis> - Lists all the rule lists whose IRIs match the specified &#39;SQL like&#39; pattern.</listitem>
</itemizedlist><ulink url="">
<para> </para>
<bridgehead class="http://www.w3.org/1999/xhtml:h4"> Creating Rewrite Rules</bridgehead>
<para> Rewrite rules take two forms: sprintf-based or regex-based.
 When used for nice URL to long URL conversion, the only difference between them is the syntax of format strings.
 The reverse long to nice conversion works only for sprintf-based rules, whereas regex-based rules are unidirectional.
 For the purpose of describing how to make dereferenceable URIs for Linked Data, we will focus on regex-based rules.</para>
<para> Regex rules are created using the URLREWRITE_CREATE_REGEX_RULE() function.</para>
<para> <ulink url="">
 </ulink></para>
<bridgehead class="http://www.w3.org/1999/xhtml:h5"> URLREWRITE_CREATE_REGEX_RULE</bridgehead>
<ulink url="">
<para> <emphasis>Function Prototype:</emphasis> </para>
<programlisting>URLREWRITE_CREATE_REGEX_RULE (
 rule_iri,
 allow_update,
 nice_match,
 nice_params,
 nice_min_params,
 target_compose,
 target_params,
 target_expn := null,
 accept_pattern := null,
 do_not_continue := 0,
 http_redirect_code := null,
 http_headers := null
 );
</programlisting><para> <ulink url="">
 <emphasis>Parameters:</emphasis></ulink></para>
<emphasis>rule_iri</emphasis> : VARCHAR <itemizedlist mark="bullet" spacing="compact"><listitem>The rule&#39;s name / identifier</listitem>
</itemizedlist><emphasis>allow_update</emphasis> : INTEGER <itemizedlist mark="bullet" spacing="compact"><listitem>Indicates whether the rule can be updated.
 1 indicates yes; 0 indicates no.
 The update is subject to the following rules: <itemizedlist mark="bullet" spacing="compact"><listitem>If the given rule_iri is already in use as a rule list identifier, an error is signalled.
</listitem>
<listitem>If the given rule_iri is already in use as a rule identifier and allow_update for the existing rule is zero, an error is signalled.
</listitem>
<listitem>If the given rule_iri is already in use as a rule identifier and allow_update for the existing rule is non-zero, the existing rule is updated.</listitem>
</itemizedlist></listitem>
</itemizedlist><emphasis>nice_match</emphasis> : VARCHAR <itemizedlist mark="bullet" spacing="compact"><listitem>A regex match expression to parse the URL into a vector of occurrences.</listitem>
</itemizedlist><emphasis>nice_params</emphasis> : ANY <itemizedlist mark="bullet" spacing="compact"><listitem>A vector of the names of the parsed parameters.
 The length of the vector should be equal to the number of &#39;(...)&#39; specifiers in the format string.</listitem>
</itemizedlist><emphasis>nice_min_params</emphasis> : INTEGER <itemizedlist mark="bullet" spacing="compact"><listitem>Used to specify the minimum number of sprintf format patterns to be matched in order to trigger the given rule.
 It only affects sprintf rules and has no effect for regex rules.</listitem>
</itemizedlist><emphasis>target_compose</emphasis> : VARCHAR <itemizedlist mark="bullet" spacing="compact"><listitem>A regex compose expression for the URL of the destination page.</listitem>
</itemizedlist><emphasis>target_params</emphasis> : ANY <itemizedlist mark="bullet" spacing="compact"><listitem>A vector of names of parameters that should be passed to the compose expression (target_compose) as $1, $2 and so on.</listitem>
</itemizedlist><emphasis>target_expn</emphasis> : VARCHAR <itemizedlist mark="bullet" spacing="compact"><listitem>Optional SQL text that should be executed instead of a regex compose call.</listitem>
</itemizedlist><emphasis>accept_pattern</emphasis> : VARCHAR <itemizedlist mark="bullet" spacing="compact"><listitem>A regex expression to match the HTTP Accept header</listitem>
</itemizedlist><emphasis>do_not_continue</emphasis> : INTEGER <itemizedlist mark="bullet" spacing="compact"><listitem>If the given rule satisfies the match conditions, <emphasis>1</emphasis> signifies do not try the next rule from same rule list, and <emphasis>0</emphasis> signifies try the next rule.</listitem>
</itemizedlist><emphasis>http_redirect_code</emphasis> : INTEGER <itemizedlist mark="bullet" spacing="compact"><listitem><emphasis>NULL</emphasis> or the integer values <emphasis>301</emphasis>, <emphasis>302</emphasis>, <emphasis>303</emphasis>, or <emphasis>406</emphasis>, are currently allowed.
 If a 3xx redirect code is given, an HTTP redirect response will be sent back to client.
 If NULL is specified, the server will process the redirect internally.</listitem>
</itemizedlist><emphasis>http_headers</emphasis> : VARCHAR <itemizedlist mark="bullet" spacing="compact"><listitem>HTTP headers to supply with the rewritten request.</listitem>
</itemizedlist><para> <ulink url="">
 </ulink></para>
<bridgehead class="http://www.w3.org/1999/xhtml:h4"> Dissection of Northwind Rewrite Rules Configured using Virtuoso PL</bridgehead>
<para> Having briefly outlined the URL Rewriting API, we return now to the Northwind rule configuration script listed earlier.</para>
<para>At the start of the script, we define a virtual directory in order to turn on URL rewriting through vhost_define().
 We first remove any existing definition for logical path /Northwind on the virtual host defined by vhost, before redefining the logical path.
 vhost specifies the host name sent to a user-agent in an HTTP response.
 This must be a valid fully-qualified host name or alias and port separated by &#39;:&#39;.
 This parameter accepts the special value &#39;*ini*&#39; which will be replaced with the hostname and port configured in the virtuoso.ini file.</para>
<para>The /Northwind virtual directory is mapped to a DAV folder (indicated by is_dav being non-zero) whose physical path is /DAV/home/demo.
 The machine hosting the virtual directory listens on the IP address and port specified by lhost (i.e.
 listen host).
 Like vhost, this accepts the special value &#39;*ini*&#39;.
 Any VSP pages contained in the virtual directory will run as user &#39;dba&#39;.</para>
<para>URL rewriting is enabled through the url_rewrite field in the opts vector; the URL rewriter will use the rule list named demo_nw_rule_list1.
 The latter is defined by the URLREWRITE_CREATE_RULELIST function call which follows.
 The rule list contains two regex-based rules, demo_nw_rule1 and demo_nw_rule2, each defined by calls to function URLREWRITE_CREATE_REGEX_RULE.</para>
<para>Consider first rule demo_nw_rule2.
 In this rule, the regular expression &#39;(/[^#]*)&#39; specified for nice_match matches the input IRI up to fragment delimiter (#).
 The corresponding occurrence is named &#39;path&#39; in the nice_params vector.
 The client must be requesting the return data as RDF serialized as N3 or RDF/XML in order for the rule to apply.</para>
<para>Argument target_compose specifies a URL-encoded template for the rewritten destination URL.
 Spaces are encoded as &#39;+&#39; or &#39;%20&#39;, the reserved character &#39;#&#39; is <ulink url="http://en.wikipedia.org/wiki/Percent-encoding">percent-encoded</ulink> as &#39;%23&#39; and the &#39;%&#39; character itself is escaped by &#39;%&#39;.</para>
<para>Removing the URL encoding and the final format specifier (&#39;&amp;format=%U&#39;), the SPARQL DESCRIBE query being built takes the form:  DESCRIBE &lt;http://^{URIQADefaultHost}^%U#this&gt; &lt;http://^{URIQADefaultHost}^%U&gt; FROM &lt;http://^{URIQADefaultHost}^/Northwind&gt; </para>
<para>Unsurprisingly this is almost identical to the SPARQL query displayed by Conductor, when the same rewrite rules are viewed through the Conductor UI.
 The only difference lies in the slightly different syntax used for parameter markers ( %U or %s , as opposed to $U1, $U2, ...
 or $s1, $s2, ...
 in Conductor).
 Here, the two sprintf-like format characters %U are placeholders which receive the first two entries in the target_params vector, i.e.
 the value of &#39;path&#39;.
 In our example, the value of &#39;path&#39; would be &#39;/Northwind/Customer/ALFKI&#39;.</para>
<para> The query response format is controlled by the format query parameter.
 In the format specifier (&#39;&amp;format=%U&#39;) at the end of the constructed query string, the third placeholder &#39;%U&#39; receives the value of the third entry in the target_params vector, &#39;*accept*&#39;.
 The &#39;*accept*&#39; parameter is used to pass the part of Accept header matched against accept_pattern, e.g.
 if the Accept header specified MIME types of &#39;application/rdf+xml, application/xml&#39; and the accept_pattern is &#39;(text/rdf.n3)|(application/rdf.xml)&#39;, then the &#39;*accept*&#39; parameter will have the value of &#39;application/rdf+xml&#39;.</para>
<para> The other rule, demo_nw_rule1, is essentially similar, but targeted at HTML browsers rather than RDF browsers.
 Rather than the internal redirect used by demo_nw_rule2, this rule returns HTTP redirect code 303 to the client when the rewrite rule is applied.
</para><table><title /><tgroup><thead /><tbody><row><entry>
<emphasis>Internal Rewrites vs External Redirects</emphasis>  <emphasis>External redirect</emphasis> : Tells the client to ask for the requested content again using a new URL and HTTP request.
 An external redirect is indicated by one of the HTTP response codes: 301 - Moved permanently (for permanent redirection) 302 - Found (the most common way of performing a redirection) 303 - See Other (the correct manner in which to redirect web applications to a new URI)  <emphasis>Internal rewrite/redirect</emphasis> : Gets the content for the requested URL from a different server file path than implied by the requested URL.
</entry></row></tbody></tgroup></table><para>As described earlier when examining the Conductor-configured rules, HTML requests are redirected to description.vsp via the Sponger proxy interface.
</para><table><title /><tgroup><thead /><tbody><row><entry>
<emphasis>System Tables Supporting URL Rewriting</emphasis><para> If you need to check your rewrite rule definitions, an alternative to inspecting them using Conductor is to query Virtuoso&#39;s system tables directly.
 The relevant system tables for URL rewriting are DB.DBA.URL_REWRITE_RULE_LIST and DB.DBA.URL_REWRITE_RULE.
 For example, the configured rule lists can be seen by executing &#39;SELECT URRL_LIST FROM DB.DBA.URL_REWRITE_RULE_LIST&#39; </para></entry></row></tbody></tgroup></table>
<ulink url="">
<para> </para>
<bridgehead class="http://www.w3.org/1999/xhtml:h5"> Data Flow in Virtuoso/PL-Defined Northwind RDF Regex Rule</bridgehead>
<para> Earlier we presented a data flow diagram showing the process of rewriting a request for an RDF representation of Northwind customer ALFKI, through a regex rule defined in the Conductor.
 Below is a similar diagram, depicting the same request rewrite, this time using the Virtuoso PL definition of the same rule.
 As before, the arcs connecting similarly coloured items illustrate how portions of the input request are matched and substituted into the rewritten request.</para>
<para><figure><graphic fileref="VirtDeployingLinkedDataGuide_UsingVirtuoso/fig10.png" /></figure> <emphasis>Breakdown of the URL rewriting process for Northwind RDF requests</emphasis> </para><ulink url="">
<para> </para>
<bridgehead class="http://www.w3.org/1999/xhtml:h3"> Northwind URL Rewriting Verification Using cURL</bridgehead>
<para> As illustrated earlier, the curl utility provides a useful tool for verifying HTTP server responses and rewrite rules.
 The first two curl exchanges below show the default Northwind URL rewrite rules being applied.</para>
<emphasis>Example 1:</emphasis> <programlisting>$ curl -I -H &quot;Accept: text/html&quot; http://demo.openlinksw.com/Northwind/Customer/ALFKI
HTTP/1.1 303 See Other
Server: Virtuoso/05.09.3037 (Solaris) x86_64-sun-solaris2.10-64 VDB
Connection: close
Content-Type: text/html; charset=ISO-8859-1
Date: Fri, 06 Feb 2009 11:11:01 GMT
Accept-Ranges: bytes
Location: http://demo.openlinksw.com/about/html/http://demo.openlinksw.com/Northwind/Customer/ALFKI
Content-Length: 0
</programlisting><para> <emphasis>Example 2:</emphasis> </para>
<programlisting>$ curl -I -H &quot;Accept: application/rdf+xml&quot; http://demo.openlinksw.com/Northwind/Customer/ALFKI
HTTP/1.1 200 OK
Server: Virtuoso/05.09.3037 (Solaris) x86_64-sun-solaris2.10-64 VDB
Connection: Keep-Alive
Date: Fri, 06 Feb 2009 11:14:49 GMT
Accept-Ranges: bytes
Content-Type: application/rdf+xml; charset=UTF-8
Content-Length: 9488
</programlisting><para> <emphasis>Example 3:</emphasis> </para>
<programlisting>$ curl -I -H &quot;Accept: application/rdf+xml&quot; http://demo.openlinksw.com/Northwind/Customer/ALFKI
HTTP/1.1 303 See Other
Server: Virtuoso/05.09.3037 (Solaris) x86_64-sun-solaris2.10-64 VDB
Connection: close
Content-Type: text/html; charset=ISO-8859-1
Date: Thu, 12 Feb 2009 11:23:31 GMT
Accept-Ranges: bytes
Location: http://demo.openlinksw.com/sparql?query=DESCRIBE+%3Chttp%3A//demo.openlinksw.com%2FNorthwind%2FCustomer%2FALFKI%23this%3E
    +%3Chttp%3A//demo.openlinksw.com%2FNorthwind%2FCustomer%2FALFKI%3E
    +FROM+%3Chttp%3A//demo.openlinksw.com/Northwind%3E&amp;format=application%2Frdf%2Bxml
Content-Length: 0
</programlisting><para> The third example shows the response generated when the default rule for RDF requests is changed to return an HTTP response code of 303, rather than use an internal redirect.
 Making this temporary change allows the generated SPARQL query to be viewed and checked with curl.</para>
<emphasis><ulink url="VirtDeployingLinkedDataGuide">Back</ulink></emphasis> to Deploying Linked Data Guide |  <emphasis><ulink url="VirtDeployingLinkedDataGuide_Introduction">Previous:</ulink></emphasis> Introduction | <emphasis><ulink url="VirtDeployingLinkedDataGuide_BrowsingNorthwindRdfView">Next:</ulink></emphasis> Browsing &amp; Exploring the Northwind Linked Data View</ulink></ulink></ulink></ulink></ulink></ulink></ulink></ulink></ulink></ulink></ulink></ulink></ulink></ulink></section></docbook>